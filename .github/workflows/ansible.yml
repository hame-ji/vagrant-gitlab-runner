name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install tools
        run: |
          pip install ansible-core ansible-lint
          wget -qO vagrant.deb https://releases.hashicorp.com/vagrant/2.4.9/vagrant_2.4.9-1_amd64.deb
          sudo dpkg -i vagrant.deb

      - name: Setup Ansible vault
        run: echo "$ANSIBLE_VAULT_PASSWORD" > .vault_pass
        env:
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

      - name: Install Ansible roles
        run: |
          find . -name requirements.yml -type f | while read -r req; do
            ansible-galaxy install -r "$req"
          done

      - name: Validate Vagrantfiles
        run: |
          shopt -s globstar nullglob
          for f in **/Vagrantfile; do
            echo "✓ Validating $f"
            (cd "$(dirname "$f")" && vagrant validate --ignore-provider)
          done

      - name: Syntax check playbooks
        run: |
          shopt -s globstar nullglob
          for playbook in **/*playbook*.yml **/site.yml; do
            echo "✓ Syntax checking $playbook"
            ansible-playbook "$playbook" --syntax-check
          done
        env:
          ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/.vault_pass

      - name: Lint Ansible
        run: ansible-lint --force-color --strict
        env:
          ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/.vault_pass
